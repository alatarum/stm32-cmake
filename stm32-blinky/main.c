#include "stm32l1xx.h"

void Init(void); //?????????? ??????? ????????????? RCC, GPIO, USART
void Usart1_Transmit(uint8_t); //?????????? ??????? ???????? ??????? ????? USART
void Usart1_Transmit_str(char* str); //?????????? ??????? ???????? ?????? ????? USART

GPIO_InitTypeDef	GPIO_InitStructure;

int main()
{
	uint32_t k = 0;
  Init(); //????? ??????? ?????????????
  while(1)
  {
    Usart1_Transmit_str("STM32L-DISCOVERY"); //????? ??????? ???????? ?????? ????? USART
    if(k & 1)
   		GPIOB->BSRRL = GPIO_Pin_9;
    else
		GPIOB->BSRRH = GPIO_Pin_9;
    k++;
    for(uint32_t i=0; i<0x002FFFFF; i++); //????????? ????????
  }
}

void Init()
{
//RCC
  RCC->CR |= RCC_CR_HSION; //???????? ???????? ????????? HSI
  while(!(RCC_CR_HSIRDY)); //???? ??? ????????????
  RCC->CFGR |= RCC_CFGR_SW_HSI; //???????? ?????????? ???????? ??????? SYSCLK ????????? HSI
  RCC->CR &= ~RCC_CR_MSION; //????????? ????????? MSI.

//GPIO
  RCC_AHBPeriphClockCmd(RCC_AHBPeriph_GPIOB, ENABLE);
  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_9;
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_OUT;
  GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_40MHz;
  GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL;
  GPIO_Init(GPIOB, &GPIO_InitStructure);

//GPIO
  RCC->AHBENR |= RCC_AHBENR_GPIOAEN; //???????? ???????????? ????? ?
  GPIOA->MODER |= GPIO_MODER_MODER9_1; //PA9 - ????? AF
  GPIOA->OTYPER &= ~GPIO_OTYPER_OT_9; //PA9 - ????? push-pull
  GPIOA->PUPDR &= ~(GPIO_PUPDR_PUPDR9); //PA9 - ??? ????????
  GPIOA->OSPEEDR |= GPIO_OSPEEDER_OSPEEDR9; //PA9 - ???????? 40 ???
  /*????? ? ??????? AFRH9[3:0] ???????? ?????????????? ??????? GPIOA_AFRH ??????????
  ???????? 0111, ??? ????? ??? ?????? PA9 ?????? ????????
  ?????????????? ??????? - AF7, ??? ????????????? USART1_TX*/
  GPIOA->AFR[1] |= (0x7<<4);

//USART1
  RCC->APB2ENR |= RCC_APB2ENR_USART1EN; //???????? ???????????? ?????? USART1
  USART1->CR1 |= USART_CR1_UE; //???????? USART1
  USART1->CR1 &= ~USART_CR1_M; //????? ????? - 8 ???
  USART1->CR2 &= ~USART_CR2_STOP; //1 ????-???
  USART1->BRR = 0x683; //baud rate 9600 ??? ??????? HSI = 16 ???
  USART1->CR1 |= USART_CR1_TE; //????????? ???????? ??????
}

//?????? ???????? ??????? ????? USART
void Usart1_Transmit(uint8_t data)
{
  while(!(USART1->SR & USART_SR_TC)); //???? ????????? ????? TC - ?????????? ????????
  USART1->DR = data;
}

//??????? ???????? ?????? ????? USART
void Usart1_Transmit_str(char* str)
{
  uint8_t i=0;
  while(str[i])
  {
    Usart1_Transmit(str[i]);
    i++;
  }
  Usart1_Transmit('\n');
  Usart1_Transmit('\r');
}
